<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Data Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --info: #4895ef;
            --warning: #f72585;
            --danger: #e63946;
            --light: #f8f9fa;
            --dark: #212529;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }
        
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            margin-bottom: 20px;
            border: none;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-weight: 600;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px 20px;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary);
            border-color: var(--secondary);
        }
        
        .form-control {
            border-radius: 8px;
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
        }
        
        .form-control:focus {
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.25);
            border-color: var(--primary);
        }
        
        .textarea-container {
            position: relative;
        }
        
        .textarea-note {
            position: absolute;
            right: 10px;
            bottom: 10px;
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        .insight-card {
            height: 100%;
            background-color: #fff;
            border-left: 4px solid var(--primary);
        }
        .dashboard-title {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 30px;
        }
        
        .nav-tabs .nav-link {
            color: #555;
            border: none;
            border-bottom: 3px solid transparent;
            margin-right: 5px;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary);
            background-color: transparent;
            border-bottom: 3px solid var(--primary);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .grade-select-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .grade-select-container label {
            margin-right: 10px;
            margin-bottom: 0;
            white-space: nowrap;
        }
        
        .help-text {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .badge {
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 30px;
        }
        
        .badge-success {
            background-color: rgba(76, 201, 240, 0.1);
            color: var(--success);
            border: 1px solid rgba(76, 201, 240, 0.3);
        }
        
        .badge-warning {
            background-color: rgba(247, 37, 133, 0.1);
            color: var(--warning);
            border: 1px solid rgba(247, 37, 133, 0.3);
        }
        
        .badge-info {
            background-color: rgba(72, 149, 239, 0.1);
            color: var(--info);
            border: 1px solid rgba(72, 149, 239, 0.3);
        }
        
        #loadingIndicator {
            display: none;
            background-color: rgba(255, 255, 255, 0.8);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        /* Style for sample data button */
        .sample-data-btn {
            text-decoration: underline;
            color: var(--primary);
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            font-size: 0.9rem;
        }
        
        #visualizationArea {
            display: none;
        }
        
        .text-primary {
            color: var(--primary) !important;
        }
        
        .section-divider {
            height: 1px;
            background-color: #e0e0e0;
            margin: 30px 0;
        }
        
        /* Custom range styling */
        .form-range::-webkit-slider-thumb {
            background: var(--primary);
        }
        
        .form-range::-moz-range-thumb {
            background: var(--primary);
        }
        
        .form-range::-ms-thumb {
            background: var(--primary);
        }
        /* Styles for column-based input */
        .column-input-container {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 15px;
            margin-bottom: 15px;
            gap: 10px;
        }
        
        .column-input {
            min-width: 150px;
            flex: 0 0 auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .column-header {
            background-color: #f8f9fa;
            padding: 8px 12px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .column-header input {
            width: 100%;
            border: none;
            background: transparent;
            font-weight: 600;
            color: var(--primary);
            padding: 4px;
            margin-right: 8px;
        }
        
        .column-header input:focus {
            outline: none;
            background-color: rgba(67, 97, 238, 0.1);
            border-radius: 4px;
        }
        
        .column-data {
            padding: 8px 12px;
        }
        
        .column-data textarea {
            width: 100%;
            min-height: 150px;
            border: none;
            resize: vertical;
            padding: 8px;
            font-size: 0.9rem;
        }
        
        .column-data textarea:focus {
            outline: none;
        }
        
        .add-column-btn {
            min-width: 60px;
            height: 176px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f8f9fa;
            border: 1px dashed #e0e0e0;
            border-radius: 8px;
            color: var(--primary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .add-column-btn:hover {
            background-color: rgba(67, 97, 238, 0.1);
            border-color: var(--primary);
        }
        
        .remove-column-btn {
            background: none;
            border: none;
            color: #6c757d;
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0;
            margin-left: 5px;
        }
        
        .remove-column-btn:hover {
            color: var(--danger);
        }
        
        .data-preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .data-preview-table th,
        .data-preview-table td {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            text-align: left;
        }
        
        .data-preview-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .data-preview-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .traditional-input-toggle {
            text-decoration: underline;
            color: var(--primary);
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            font-size: 0.9rem;
            margin-left: 10px;
        }
        
        #traditionalInputContainer {
            display: none;
        }
        
        /* Security warning banner */
        .security-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
        }
        
        .security-warning-title {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }
        
        .security-warning-icon {
            font-size: 1.2rem;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <h1 class="dashboard-title text-center">Teacher Data Dashboard</h1>
        
        <!-- Security Warning Banner -->
        <div class="security-warning">
            <div class="security-warning-title">
                <span class="security-warning-icon">⚠️</span>
                Security Warning
            </div>
            <p class="mb-0">DO NOT enter real student data as this site is not secure. This is just a demo. Load the sample data instead. If you're interested in trying something like this out, contact Henry.</p>
        </div>
        
        <div class="card" id="dataInputCard">
            <div class="card-header">
                Step 1: Enter Your Data
            </div>
            <div class="card-body">
                <!-- Column-based input -->
                <div id="columnInputContainer">
                    <div class="mb-3">
                        <label class="form-label">Enter your data by columns:</label>
                        <p class="help-text">Add columns and paste data into each. First column should be student names.</p>
                        
                        <div class="column-input-container" id="columnInputs">
                            <!-- Default student names column -->
                            <div class="column-input" data-column-index="0">
                                <div class="column-header">
                                    <input type="text" value="Student" placeholder="Column name">
                                </div>
                                <div class="column-data">
                                    <textarea placeholder="Paste student names here, one per line"></textarea>
                                </div>
                            </div>
                            
                            <!-- Add column button -->
                            <div class="add-column-btn" id="addColumnBtn">+</div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <button class="sample-data-btn" id="loadSampleDataColumns">Load sample data</button>
                            <span class="help-text">Tip: Copy directly from your spreadsheet</span>
                        </div>
                    </div>
                    
                    <!-- Data preview -->
                    <div class="mt-4">
                        <h6>Data Preview:</h6>
                        <div class="table-responsive">
                            <table class="data-preview-table" id="dataPreviewTable">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="1" class="text-center">No data yet. Paste data in columns above.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="gradeSystem" class="form-label">Grade system:</label>
                            <select class="form-select" id="gradeSystem">
                                <option value="percentage">Percentages (0-100%)</option>
                                <option value="raw-score">Raw scores (specify max below)</option>
                                <option value="letter-grade">Letter grades (A, B, C, etc.)</option>
                                <option value="number-grade">Number grades (9-1, 1-7, etc.)</option>
                                <option value="qualitative">Qualitative (Exceeding, Good, Working towards, Concern)</option>
                            </select>
                        </div>
                        
                        <div id="rawScoreMaxContainer" class="mb-3" style="display: none;">
                            <label for="rawScoreMax" class="form-label">Maximum possible score:</label>
                            <input type="number" class="form-control" id="rawScoreMax" value="20">
                        </div>
                        
                        <div id="letterGradeContainer" class="mb-3" style="display: none;">
                            <div class="grade-select-container">
                                <label>Grades from highest to lowest:</label>
                                <input type="text" class="form-control" id="letterGradeOrder" value="A+,A,A-,B+,B,B-,C+,C,C-,D+,D,D-,F">
                            </div>
                            <div class="help-text">Separate grades with commas</div>
                        </div>
                        
                        <div id="numberGradeContainer" class="mb-3" style="display: none;">
                            <div class="row">
                                <div class="col-6">
                                    <label for="numberGradeMax" class="form-label">Highest grade:</label>
                                    <input type="number" class="form-control" id="numberGradeMax" value="9">
                                </div>
                                <div class="col-6">
                                    <label for="numberGradeMin" class="form-label">Lowest grade:</label>
                                    <input type="number" class="form-control" id="numberGradeMin" value="1">
                                </div>
                            </div>
                            <div class="mt-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="numberGradeReversed">
                                    <label class="form-check-label" for="numberGradeReversed">
                                        Reversed (lower number is better)
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div id="qualitativeGradeContainer" class="mb-3" style="display: none;">
                            <div class="grade-select-container">
                                <label>Qualitative grades from highest to lowest:</label>
                                <input type="text" class="form-control" id="qualitativeGradeOrder" value="Exceeding,Good,Working towards,Concern">
                            </div>
                            <div class="help-text">Separate grades with commas</div>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                    <button class="btn btn-primary" id="generateDashboard">Generate Dashboard</button>
                </div>
            </div>
        </div>
        
        <div id="visualizationArea">
            <div class="card">
                <div class="card-header">
                    Class Performance Overview
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <div class="stat-value" id="classAverage">-</div>
                                    <div class="stat-label">Class Average</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <div class="stat-value" id="medianScore">-</div>
                                    <div class="stat-label">Median Score</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <div class="stat-value" id="highestScore">-</div>
                                    <div class="stat-label">Highest Score</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <div class="stat-value" id="lowestScore">-</div>
                                    <div class="stat-label">Lowest Score</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <ul class="nav nav-tabs mb-3" id="chartTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="distribution-tab" data-bs-toggle="tab" data-bs-target="#distribution" type="button" role="tab">Score Distribution</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="student-comparison-tab" data-bs-toggle="tab" data-bs-target="#student-comparison" type="button" role="tab">Student Comparison</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="assessment-comparison-tab" data-bs-toggle="tab" data-bs-target="#assessment-comparison" type="button" role="tab">Assessment Comparison</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="chartTabsContent">
                        <div class="tab-pane fade show active" id="distribution" role="tabpanel">
                            <div class="chart-container">
                                <canvas id="distributionChart"></canvas>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="student-comparison" role="tabpanel">
                            <div class="chart-container">
                                <canvas id="studentComparisonChart"></canvas>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="assessment-comparison" role="tabpanel">
                            <div class="chart-container">
                                <canvas id="assessmentComparisonChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section-divider"></div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            Performance Insights
                        </div>
                        <div class="card-body">
                            <div id="insightsContainer">
                                <!-- Insights will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            Student Performance Groups
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="highPerformanceThreshold" class="form-label">High Performance Threshold:</label>
                                <div class="d-flex align-items-center">
                                    <input type="range" class="form-range" id="highPerformanceThreshold" min="50" max="100" value="80">
                                    <span class="ms-2" id="highPerformanceThresholdValue">80%</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="lowPerformanceThreshold" class="form-label">Low Performance Threshold:</label>
                                <div class="d-flex align-items-center">
                                    <input type="range" class="form-range" id="lowPerformanceThreshold" min="0" max="50" value="40">
                                    <span class="ms-2" id="lowPerformanceThresholdValue">40%</span>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="performanceGroupsChart"></canvas>
                            </div>
                            <div id="performanceGroupsList" class="mt-3">
                                <!-- Performance groups will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section-divider"></div>
            
            <div class="card">
                <div class="card-header">
                    Individual Student Focus
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="studentSelect" class="form-label">Select a student:</label>
                                <select class="form-select" id="studentSelect">
                                    <option value="">Choose a student</option>
                                </select>
                            </div>
                            <div id="studentStats">
                                <!-- Student stats will be inserted here -->
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="chart-container">
                                <canvas id="studentDetailChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="section-divider"></div>
            
            <div class="card mb-5">
                <div class="card-header">
                    Export Options
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p>Save your dashboard data and visualizations for later use.</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-outline-primary me-2" id="saveDashboardBtn">Save Dashboard</button>
                            <button class="btn btn-outline-primary me-2" id="printDashboardBtn">Print Dashboard</button>
                            <div class="btn-group">
                                <button class="btn btn-primary dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    Export Data
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                                    <li><a class="dropdown-item" href="#" id="exportPDF">Export as PDF</a></li>
                                    <li><a class="dropdown-item" href="#" id="exportCSV">Export as CSV</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="loadingIndicator">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Wait for both DOM content and Chart.js to be fully loaded
        window.onload = function() {
            // Sample data for demonstration with English assessments in different formats
            const sampleData = `Student\tEnglish Essay\tGrammar Test\tReading Assessment\tSpeaking Presentation\tLiterature Project
Alex\t85%\t8\tGood\tExceeding\t78%
Jamie\t76%\t6\tWorking towards\tGood\t82%
Casey\t92%\t9\tExceeding\tExceeding\t95%
Aadil\t68%\t4\tConcern\tWorking towards\t72%
Taylor\t85%\t7\tGood\tGood\t88%
Jordan\t79%\t5\tWorking towards\tGood\t75%
Nikhil\t65%\t3\tConcern\tWorking towards\t70%
Quinn\t90%\t8\tExceeding\tExceeding\t87%
Avery\t78%\t6\tGood\tWorking towards\t75%
Jacob\t83%\t7\tGood\tGood\t85%`;
            
            // Parse sample data for column-based input
            const sampleDataParsed = parseSampleData(sampleData);
            
            // Load sample data button (column-based)
            document.getElementById('loadSampleDataColumns').addEventListener('click', function() {
                // Clear existing columns except the first one
                const columnInputs = document.getElementById('columnInputs');
                while (columnInputs.children.length > 2) {
                    columnInputs.removeChild(columnInputs.children[1]);
                }
                
                // Set the first column header and data
                const firstColumn = columnInputs.querySelector('.column-input');
                firstColumn.querySelector('input').value = sampleDataParsed.headers[0];
                firstColumn.querySelector('textarea').value = sampleDataParsed.columns[0].join('\n');
                
                // Add remaining columns
                for (let i = 1; i < sampleDataParsed.headers.length; i++) {
                    addColumn(sampleDataParsed.headers[i], sampleDataParsed.columns[i].join('\n'));
                }
                
                // Update the preview
                updateDataPreview();
            });
            
            // Add column button
            document.getElementById('addColumnBtn').addEventListener('click', function() {
                addColumn();
                updateDataPreview();
            });
            
            // Add initial column listeners
            addColumnListeners(document.querySelector('.column-input'));
            
            // Function to add a new column
            function addColumn(headerName = '', data = '') {
                const columnInputs = document.getElementById('columnInputs');
                const addColumnBtn = document.getElementById('addColumnBtn');
                
                // Create new column
                const newColumn = document.createElement('div');
                newColumn.className = 'column-input';
                newColumn.dataset.columnIndex = columnInputs.querySelectorAll('.column-input').length;
                
                newColumn.innerHTML = `
                    <div class="column-header">
                        <input type="text" value="${headerName}" placeholder="Column name">
                        <button class="remove-column-btn" title="Remove column">×</button>
                    </div>
                    <div class="column-data">
                        <textarea placeholder="Paste data here, one value per line">${data}</textarea>
                    </div>
                `;
                
                // Add before the + button
                columnInputs.insertBefore(newColumn, addColumnBtn);
                
                // Add listeners
                addColumnListeners(newColumn);
                
                return newColumn;
            }
            
            // Add event listeners to column elements
            function addColumnListeners(column) {
                // Header input change
                column.querySelector('input').addEventListener('input', function() {
                    updateDataPreview();
                });
                
                // Textarea input change
                column.querySelector('textarea').addEventListener('input', function() {
                    updateDataPreview();
                });
                
                // Remove button click
                const removeBtn = column.querySelector('.remove-column-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        column.remove();
                        updateDataPreview();
                    });
                }
            }
            
            // Update data preview table
            function updateDataPreview() {
                const columns = document.querySelectorAll('.column-input');
                if (columns.length === 0) return;
                
                // Get column headers and data
                const headers = Array.from(columns).map(col => col.querySelector('input').value || 'Unnamed');
                const data = Array.from(columns).map(col => col.querySelector('textarea').value.split('\n').filter(line => line.trim()));
                
                // Get max number of rows
                const maxRows = Math.max(...data.map(col => col.length));
                
                // Create table header
                const tableHeader = document.querySelector('#dataPreviewTable thead tr');
                tableHeader.innerHTML = '';
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    tableHeader.appendChild(th);
                });
                
                // Create table body
                const tableBody = document.querySelector('#dataPreviewTable tbody');
                tableBody.innerHTML = '';
                
                if (maxRows === 0) {
                    const row = document.createElement('tr');
                    const cell = document.createElement('td');
                    cell.textContent = 'No data yet. Paste data in columns above.';
                    cell.colSpan = headers.length;
                    cell.className = 'text-center';
                    row.appendChild(cell);
                    tableBody.appendChild(row);
                } else {
                    // Create rows with data
                    for (let i = 0; i < maxRows; i++) {
                        const row = document.createElement('tr');
                        
                        for (let j = 0; j < data.length; j++) {
                            const cell = document.createElement('td');
                            cell.textContent = data[j][i] || '';
                            row.appendChild(cell);
                        }
                        
                        tableBody.appendChild(row);
                    }
                }
            }
            
            // Parse sample data into columns
            function parseSampleData(data) {
                const lines = data.split('\n').filter(line => line.trim());
                if (lines.length === 0) return { headers: [], columns: [] };
                
                let delimiter;
                if (data.includes('\t')) {
                    delimiter = '\t';
                } else if (data.includes(',')) {
                    delimiter = ',';
                } else if (data.includes(';')) {
                    delimiter = ';';
                } else {
                    delimiter = '\t'; // Default to tab
                }
                
                const headers = lines[0].split(delimiter).map(h => h.trim());
                const columns = Array(headers.length).fill().map(() => []);
                
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(delimiter);
                    for (let j = 0; j < values.length && j < headers.length; j++) {
                        columns[j].push(values[j].trim());
                    }
                }
                
                return { headers, columns };
            }
            
            // Convert column data to traditional format
            function convertColumnDataToTraditional() {
                const columns = document.querySelectorAll('.column-input');
                if (columns.length === 0) return '';
                
                // Get column headers and data
                const headers = Array.from(columns).map(col => col.querySelector('input').value || 'Unnamed');
                const data = Array.from(columns).map(col => col.querySelector('textarea').value.split('\n').filter(line => line.trim()));
                
                // Get max number of rows
                const maxRows = Math.max(...data.map(col => col.length));
                
                let result = headers.join('\t') + '\n';
                
                for (let i = 0; i < maxRows; i++) {
                    const rowData = [];
                    for (let j = 0; j < data.length; j++) {
                        rowData.push(data[j][i] || '');
                    }
                    result += rowData.join('\t') + '\n';
                }
                
                return result;
            }
            
            // Show/hide appropriate grade system inputs
            document.getElementById('gradeSystem').addEventListener('change', function() {
                const selectedSystem = this.value;
                document.getElementById('rawScoreMaxContainer').style.display = selectedSystem === 'raw-score' ? 'block' : 'none';
                document.getElementById('letterGradeContainer').style.display = selectedSystem === 'letter-grade' ? 'block' : 'none';
                document.getElementById('numberGradeContainer').style.display = selectedSystem === 'number-grade' ? 'block' : 'none';
                document.getElementById('qualitativeGradeContainer').style.display = selectedSystem === 'qualitative' ? 'block' : 'none';
            });
            
            // Update high performance threshold value display
            document.getElementById('highPerformanceThreshold').addEventListener('input', function() {
                document.getElementById('highPerformanceThresholdValue').textContent = `${this.value}%`;
                updatePerformanceGroups();
            });
            
            // Update low performance threshold value display
            document.getElementById('lowPerformanceThreshold').addEventListener('input', function() {
                document.getElementById('lowPerformanceThresholdValue').textContent = `${this.value}%`;
                updatePerformanceGroups();
            });
            
            // Generate dashboard button click
            document.getElementById('generateDashboard').addEventListener('click', function() {
                let dataInput;
                
                // Using column-based input
                dataInput = convertColumnDataToTraditional();
                if (!dataInput.trim()) {
                    alert('Please enter some data in the columns first.');
                    return;
                }
                
                try {
                    // Show loading indicator
                    const loadingIndicator = document.getElementById('loadingIndicator');
                    loadingIndicator.style.display = 'flex';
                    
                    // Give time for the UI to update before processing (helps with the loading indicator)
                    setTimeout(() => {
                        try {
                            processData(dataInput, 'students-in-rows', 'auto');
                            document.getElementById('visualizationArea').style.display = 'block';
                            
                            // Scroll to visualization area
                            document.getElementById('visualizationArea').scrollIntoView({ behavior: 'smooth' });
                        } catch (error) {
                            console.error('Error processing data:', error);
                            alert('An error occurred while processing your data. Please check the format and try again.');
                        } finally {
                            // Ensure loading indicator is hidden even if there's an error
                            loadingIndicator.style.display = 'none';
                        }
                    }, 100);
                } catch (error) {
                    console.error('Error in button click handler:', error);
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            });
            
            // Global variables to store processed data
            let processedData = {
                students: [],
                assessments: [],
                scores: [],
                normalizedScores: []
            };
            
            // Process the data
            function processData(dataInput, dataFormat, delimiterType) {
                // Determine delimiter
                let delimiter;
                if (delimiterType === 'auto') {
                    if (dataInput.includes('\t')) {
                        delimiter = '\t';
                    } else if (dataInput.includes(',')) {
                        delimiter = ',';
                    } else if (dataInput.includes(';')) {
                        delimiter = ';';
                    } else {
                        delimiter = '\t'; // Default to tab
                    }
                } else if (delimiterType === 'tab') {
                    delimiter = '\t';
                } else if (delimiterType === 'comma') {
                    delimiter = ',';
                } else if (delimiterType === 'semicolon') {
                    delimiter = ';';
                }
                
                // Parse the data
                const lines = dataInput.split('\n').filter(line => line.trim());
                const headers = lines[0].split(delimiter);
                
                // Initialize processedData
                processedData = {
                    students: [],
                    assessments: [],
                    scores: [],
                    normalizedScores: []
                };
                
                if (dataFormat === 'students-in-rows') {
                    // First column is student names, first row is assessment names
                    processedData.students = lines.slice(1).map(line => line.split(delimiter)[0]);
                    processedData.assessments = headers.slice(1);
                    
                    // Extract scores
                    processedData.scores = lines.slice(1).map(line => {
                        const values = line.split(delimiter).slice(1);
                        return values.map(value => value.trim());
                    });
                } else {
                    // First column is assessment names, first row is student names
                    processedData.assessments = lines.slice(1).map(line => line.split(delimiter)[0]);
                    processedData.students = headers.slice(1);
                    
                    // Extract scores and transpose
                    const tempScores = lines.slice(1).map(line => {
                        const values = line.split(delimiter).slice(1);
                        return values.map(value => value.trim());
                    });
                    
                    // Transpose the matrix
                    processedData.scores = Array(processedData.students.length).fill().map(() => Array(processedData.assessments.length).fill(''));
                    for (let i = 0; i < tempScores.length; i++) {
                        for (let j = 0; j < tempScores[i].length; j++) {
                            processedData.scores[j][i] = tempScores[i][j];
                        }
                    }
                }
                
                // Normalize scores based on grading system
                normalizeScores(document.getElementById('gradeSystem').value);
                
                // Generate visualizations
                generateVisualizations();
            }
            
            // Normalize scores based on the grading system - automatically detect and handle different data types
            function normalizeScores(gradeSystem) {
                // Get configuration values once for all conversions
                const letterGrades = document.getElementById('letterGradeOrder').value.split(',').map(g => g.trim());
                const qualitativeGrades = document.getElementById('qualitativeGradeOrder').value.split(',').map(g => g.trim());
                const max = parseFloat(document.getElementById('numberGradeMax').value);
                const min = parseFloat(document.getElementById('numberGradeMin').value);
                const reversed = document.getElementById('numberGradeReversed').checked;
                const maxScore = parseFloat(document.getElementById('rawScoreMax').value);
                
                processedData.normalizedScores = processedData.scores.map(studentScores => {
                    return studentScores.map(score => {
                        if (score === '' || score === null || score === undefined) {
                            return null; // Handle missing data
                        }
                        
                        // Auto-detect the data type and convert accordingly
                        
                        // Check if it's a percentage score
                        if (typeof score === 'string' && score.includes('%')) {
                            return parseFloat(score.replace('%', ''));
                        }
                        
                        // Check if it's a qualitative grade
                        if (typeof score === 'string' && qualitativeGrades.includes(score)) {
                            const qualIndex = qualitativeGrades.indexOf(score);
                            return 100 - ((qualIndex / (qualitativeGrades.length - 1)) * 100);
                        }
                        
                        // Check if it's a letter grade
                        if (typeof score === 'string' && letterGrades.includes(score)) {
                            const index = letterGrades.indexOf(score);
                            return 100 - ((index / (letterGrades.length - 1)) * 100);
                        }
                        
                        // Assume it's a number grade or raw score
                        const value = parseFloat(score);
                        if (!isNaN(value)) {
                            // If it's a small number (1-9), treat as a grade scale
                            if (value >= min && value <= max) {
                                if (reversed) {
                                    // Lower is better (e.g., 1 is best in 1-7 scale)
                                    return ((max - value) / (max - min)) * 100;
                                } else {
                                    // Higher is better (e.g., 9 is best in 9-1 scale)
                                    return ((value - min) / (max - min)) * 100;
                                }
                            }
                            
                            // If it's a larger number but less than 100, assume it's already a percentage
                            if (value <= 100) {
                                return value;
                            }
                            
                            // Otherwise, treat as raw score
                            return (value / maxScore) * 100;
                        }
                        
                        return null; // If we can't convert it
                    });
                });
            }
            
            // Generate all visualizations
            function generateVisualizations() {
                updateStatistics();
                createDistributionChart();
                createStudentComparisonChart();
                createAssessmentComparisonChart();
                updatePerformanceGroups();
                generateInsights();
                populateStudentSelect();
            }
            
            // Update statistics display
            function updateStatistics() {
                // Flatten all normalized scores
                const allScores = processedData.normalizedScores.flat().filter(score => score !== null && !isNaN(score));
                
                // Check if we have any valid scores
                if (allScores.length === 0) {
                    document.getElementById('classAverage').textContent = '0.0%';
                    document.getElementById('medianScore').textContent = '0.0%';
                    document.getElementById('highestScore').textContent = '0.0%';
                    document.getElementById('lowestScore').textContent = '0.0%';
                    return;
                }
                
                // Calculate statistics
                const average = allScores.reduce((sum, score) => sum + score, 0) / allScores.length;
                const sortedScores = [...allScores].sort((a, b) => a - b);
                const median = sortedScores.length % 2 === 0 
                    ? (sortedScores[sortedScores.length / 2 - 1] + sortedScores[sortedScores.length / 2]) / 2
                    : sortedScores[Math.floor(sortedScores.length / 2)];
                const highest = Math.max(...allScores);
                const lowest = Math.min(...allScores);
                
                // Update display with defensive checks
                document.getElementById('classAverage').textContent = `${isNaN(average) ? '0.0' : average.toFixed(1)}%`;
                document.getElementById('medianScore').textContent = `${isNaN(median) ? '0.0' : median.toFixed(1)}%`;
                document.getElementById('highestScore').textContent = `${isNaN(highest) ? '0.0' : highest.toFixed(1)}%`;
                document.getElementById('lowestScore').textContent = `${isNaN(lowest) ? '0.0' : lowest.toFixed(1)}%`;
            }
            
            // Create distribution chart
            function createDistributionChart() {
                try {
                    const canvas = document.getElementById('distributionChart');
                    const ctx = canvas.getContext('2d');
                    
                    // Destroy existing chart if it exists
                    if (window.distributionChart && typeof window.distributionChart.destroy === 'function') {
                        window.distributionChart.destroy();
                        window.distributionChart = null;
                    }
                    
                    // Clear the canvas to prevent ghost images
                    canvas.width = canvas.width;
                    
                    // Flatten all normalized scores
                    const allScores = processedData.normalizedScores.flat().filter(score => score !== null);
                    
                    // Create histogram data
                    const bins = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100];
                    const counts = Array(bins.length - 1).fill(0);
                    
                    allScores.forEach(score => {
                        for (let i = 0; i < bins.length - 1; i++) {
                            if (score >= bins[i] && score < bins[i + 1]) {
                                counts[i]++;
                                break;
                            }
                            // Handle the edge case for score = 100
                            if (score === 100 && i === bins.length - 2) {
                                counts[i]++;
                            }
                        }
                    });
                    
                    // Create chart
                    window.distributionChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: bins.slice(0, -1).map((bin, i) => `${bin}-${bins[i+1]}%`),
                            datasets: [{
                                label: 'Number of Scores',
                                data: counts,
                                backgroundColor: 'rgba(67, 97, 238, 0.7)',
                                borderColor: 'rgba(67, 97, 238, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Score Distribution'
                                },
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Number of Scores'
                                    },
                                    ticks: {
                                        stepSize: 1
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Score Range'
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error creating distribution chart:', error);
                }
            }
            
            // Create student comparison chart
            function createStudentComparisonChart() {
                const ctx = document.getElementById('studentComparisonChart').getContext('2d');
                
                // Calculate student averages
                const studentAverages = processedData.normalizedScores.map(scores => {
                    const validScores = scores.filter(score => score !== null);
                    return validScores.length > 0 
                        ? validScores.reduce((sum, score) => sum + score, 0) / validScores.length 
                        : 0;
                });
                
                // Destroy existing chart if it exists
                if (window.studentComparisonChart && typeof window.studentComparisonChart.destroy === 'function') {
                    window.studentComparisonChart.destroy();
                }
                
                // Create chart
                window.studentComparisonChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: processedData.students,
                        datasets: [{
                            label: 'Average Score',
                            data: studentAverages,
                            backgroundColor: studentAverages.map(score => {
                                if (score >= 80) return 'rgba(76, 201, 240, 0.7)';
                                if (score >= 60) return 'rgba(72, 149, 239, 0.7)';
                                if (score >= 40) return 'rgba(255, 183, 3, 0.7)';
                                return 'rgba(247, 37, 133, 0.7)';
                            }),
                            borderColor: studentAverages.map(score => {
                                if (score >= 80) return 'rgba(76, 201, 240, 1)';
                                if (score >= 60) return 'rgba(72, 149, 239, 1)';
                                if (score >= 40) return 'rgba(255, 183, 3, 1)';
                                return 'rgba(247, 37, 133, 1)';
                            }),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Student Average Performance'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Average Score (%)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Students'
                                }
                            }
                        }
                    }
                });
            }
            
            // Create assessment comparison chart
            function createAssessmentComparisonChart() {
                const ctx = document.getElementById('assessmentComparisonChart').getContext('2d');
                
                // Calculate assessment averages
                const assessmentAverages = [];
                for (let i = 0; i < processedData.assessments.length; i++) {
                    const assessmentScores = processedData.normalizedScores.map(studentScores => studentScores[i]).filter(score => score !== null);
                    const average = assessmentScores.length > 0 
                        ? assessmentScores.reduce((sum, score) => sum + score, 0) / assessmentScores.length 
                        : 0;
                    assessmentAverages.push(average);
                }
                
                // Destroy existing chart if it exists
                if (window.assessmentComparisonChart && typeof window.assessmentComparisonChart.destroy === 'function') {
                    window.assessmentComparisonChart.destroy();
                }
                
                // Create chart
                window.assessmentComparisonChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: processedData.assessments,
                        datasets: [{
                            label: 'Class Average',
                            data: assessmentAverages,
                            backgroundColor: 'rgba(67, 97, 238, 0.2)',
                            borderColor: 'rgba(67, 97, 238, 1)',
                            borderWidth: 3,
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Class Performance Across Assessments'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Average Score (%)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Assessments'
                                }
                            }
                        }
                    }
                });
            }
            
            // Update performance groups
            function updatePerformanceGroups() {
                const highThreshold = parseInt(document.getElementById('highPerformanceThreshold').value);
                const lowThreshold = parseInt(document.getElementById('lowPerformanceThreshold').value);
                
                // Calculate student averages
                const studentAverages = processedData.normalizedScores.map(scores => {
                    const validScores = scores.filter(score => score !== null);
                    return validScores.length > 0 
                        ? validScores.reduce((sum, score) => sum + score, 0) / validScores.length 
                        : 0;
                });
                
                // Count students in each group
                const highPerformers = studentAverages.filter(avg => avg >= highThreshold).length;
                const midPerformers = studentAverages.filter(avg => avg >= lowThreshold && avg < highThreshold).length;
                const lowPerformers = studentAverages.filter(avg => avg < lowThreshold).length;
                
                const ctx = document.getElementById('performanceGroupsChart').getContext('2d');
                
                // Destroy existing chart if it exists
                if (window.performanceGroupsChart && typeof window.performanceGroupsChart.destroy === 'function') {
                    window.performanceGroupsChart.destroy();
                }
                
                // Create chart
                window.performanceGroupsChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['High Performers', 'Mid Performers', 'Low Performers'],
                        datasets: [{
                            data: [highPerformers, midPerformers, lowPerformers],
                            backgroundColor: [
                                'rgba(76, 201, 240, 0.7)',
                                'rgba(72, 149, 239, 0.7)',
                                'rgba(247, 37, 133, 0.7)'
                            ],
                            borderColor: [
                                'rgba(76, 201, 240, 1)',
                                'rgba(72, 149, 239, 1)',
                                'rgba(247, 37, 133, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                
                // Update performance groups list
                const highPerformersList = [];
                const midPerformersList = [];
                const lowPerformersList = [];
                
                studentAverages.forEach((avg, index) => {
                    if (avg >= highThreshold) {
                        highPerformersList.push(processedData.students[index]);
                    } else if (avg >= lowThreshold) {
                        midPerformersList.push(processedData.students[index]);
                    } else {
                        lowPerformersList.push(processedData.students[index]);
                    }
                });
                
                const performanceGroupsListEl = document.getElementById('performanceGroupsList');
                performanceGroupsListEl.innerHTML = `
                    <div class="mb-2">
                        <span class="badge badge-success">High Performers (${highPerformersList.length})</span>
                        <div class="mt-1">${highPerformersList.join(', ') || 'None'}</div>
                    </div>
                    <div class="mb-2">
                        <span class="badge badge-info">Mid Performers (${midPerformersList.length})</span>
                        <div class="mt-1">${midPerformersList.join(', ') || 'None'}</div>
                    </div>
                    <div>
                        <span class="badge badge-warning">Low Performers (${lowPerformersList.length})</span>
                        <div class="mt-1">${lowPerformersList.join(', ') || 'None'}</div>
                    </div>
                `;
            }
            
            // Generate insights
            function generateInsights() {
                const insightsContainer = document.getElementById('insightsContainer');
                const insights = [];
                
                // Calculate assessment averages
                const assessmentAverages = [];
                for (let i = 0; i < processedData.assessments.length; i++) {
                    const assessmentScores = processedData.normalizedScores.map(studentScores => studentScores[i]).filter(score => score !== null);
                    const average = assessmentScores.length > 0 
                        ? assessmentScores.reduce((sum, score) => sum + score, 0) / assessmentScores.length 
                        : 0;
                    assessmentAverages.push({
                        name: processedData.assessments[i],
                        average: average
                    });
                }
                
                // Calculate student averages
                const studentAverages = processedData.normalizedScores.map((scores, index) => {
                    const validScores = scores.filter(score => score !== null);
                    return {
                        name: processedData.students[index],
                        average: validScores.length > 0 
                            ? validScores.reduce((sum, score) => sum + score, 0) / validScores.length 
                            : 0,
                        scores: scores
                    };
                });
                
                // Sort assessments by average
                const sortedAssessments = [...assessmentAverages].sort((a, b) => a.average - b.average);
                
                // Find highest and lowest performing assessments
                if (sortedAssessments.length > 0) {
                    insights.push({
                        icon: '📊',
                        title: 'Assessment Performance',
                        content: `The highest class average was in <strong>${sortedAssessments[sortedAssessments.length - 1].name}</strong> (${sortedAssessments[sortedAssessments.length - 1].average.toFixed(1)}%), while the lowest was in <strong>${sortedAssessments[0].name}</strong> (${sortedAssessments[0].average.toFixed(1)}%).`
                    });
                }
                
                // Check if there's a trend across assessments
                if (assessmentAverages.length > 2) {
                    let trend = true;
                    let increasing = assessmentAverages[1].average > assessmentAverages[0].average;
                    
                    for (let i = 2; i < assessmentAverages.length; i++) {
                        if ((increasing && assessmentAverages[i].average <= assessmentAverages[i-1].average) ||
                            (!increasing && assessmentAverages[i].average >= assessmentAverages[i-1].average)) {
                            trend = false;
                            break;
                        }
                    }
                    
                    if (trend) {
                        insights.push({
                            icon: '📈',
                            title: 'Performance Trend',
                            content: `The class is showing a consistent ${increasing ? 'improving' : 'declining'} trend across assessments.`
                        });
                    }
                }
                
                // Identify students who need attention (consistently low performance)
                const studentsNeedingAttention = studentAverages
                    .filter(student => student.average < 60)
                    .sort((a, b) => a.average - b.average)
                    .slice(0, 3);
                
                if (studentsNeedingAttention.length > 0) {
                    insights.push({
                        icon: '⚠️',
                        title: 'Students Needing Support',
                        content: `${studentsNeedingAttention.map(s => `<strong>${s.name}</strong> (${s.average.toFixed(1)}%)`).join(', ')} may need additional support based on their performance.`
                    });
                }
                
                // Identify outstanding performers
                const outstandingPerformers = studentAverages
                    .filter(student => student.average > 90)
                    .sort((a, b) => b.average - a.average)
                    .slice(0, 3);
                
                if (outstandingPerformers.length > 0) {
                    insights.push({
                        icon: '🌟',
                        title: 'Outstanding Performers',
                        content: `${outstandingPerformers.map(s => `<strong>${s.name}</strong> (${s.average.toFixed(1)}%)`).join(', ')} are showing exceptional performance.`
                    });
                }
                
                // Identify students with high variance (inconsistent performance)
                const studentsWithVariance = studentAverages.map(student => {
                    const validScores = student.scores.filter(score => score !== null);
                    if (validScores.length < 2) return null;
                    
                    const mean = validScores.reduce((sum, score) => sum + score, 0) / validScores.length;
                    const variance = validScores.reduce((sum, score) => sum + Math.pow(score - mean, 2), 0) / validScores.length;
                    const stdDev = Math.sqrt(variance);
                    
                    return {
                        name: student.name,
                        stdDev: stdDev
                    };
                }).filter(s => s !== null)
                  .sort((a, b) => b.stdDev - a.stdDev)
                  .slice(0, 3);
                
                if (studentsWithVariance.length > 0) {
                    insights.push({
                        icon: '📊',
                        title: 'Inconsistent Performance',
                        content: `${studentsWithVariance.map(s => `<strong>${s.name}</strong>`).join(', ')} show the most variance in scores, which may indicate inconsistent understanding or engagement.`
                    });
                }
                
                // Generate class size insight
                insights.push({
                    icon: '👥',
                    title: 'Class Size',
                    content: `This class has <strong>${processedData.students.length}</strong> students across <strong>${processedData.assessments.length}</strong> assessments.`
                });
                
                // Display insights
                insightsContainer.innerHTML = insights.map(insight => `
                    <div class="card insight-card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">
                                <span class="me-2">${insight.icon}</span>
                                ${insight.title}
                            </h5>
                            <p class="card-text">${insight.content}</p>
                        </div>
                    </div>
                `).join('');
            }
            
            // Populate student select dropdown
            function populateStudentSelect() {
                const studentSelect = document.getElementById('studentSelect');
                studentSelect.innerHTML = '<option value="">Choose a student</option>';
                
                processedData.students.forEach((student, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = student;
                    studentSelect.appendChild(option);
                });
                
                studentSelect.addEventListener('change', function() {
                    const selectedIndex = parseInt(this.value);
                    if (!isNaN(selectedIndex)) {
                        displayStudentDetails(selectedIndex);
                    } else {
                        document.getElementById('studentStats').innerHTML = '';
                        if (window.studentDetailChart && typeof window.studentDetailChart.destroy === 'function') {
                            window.studentDetailChart.destroy();
                        }
                    }
                });
            }
            
            // Display student details
            function displayStudentDetails(studentIndex) {
                const student = processedData.students[studentIndex];
                const scores = processedData.normalizedScores[studentIndex];
                
                // Calculate statistics
                const validScores = scores.filter(score => score !== null);
                const average = validScores.length > 0 
                    ? validScores.reduce((sum, score) => sum + score, 0) / validScores.length 
                    : 0;
                
                // Find best and worst performances
                let bestIndex = 0;
                let worstIndex = 0;
                let bestScore = -1;
                let worstScore = 101;
                
                for (let i = 0; i < scores.length; i++) {
                    if (scores[i] !== null) {
                        if (scores[i] > bestScore) {
                            bestScore = scores[i];
                            bestIndex = i;
                        }
                        if (scores[i] < worstScore) {
                            worstScore = scores[i];
                            worstIndex = i;
                        }
                    }
                }
                
                // Calculate class average
                const classAverages = [];
                for (let i = 0; i < processedData.assessments.length; i++) {
                    const assessmentScores = processedData.normalizedScores.map(studentScores => studentScores[i]).filter(score => score !== null);
                    const avg = assessmentScores.length > 0 
                        ? assessmentScores.reduce((sum, score) => sum + score, 0) / assessmentScores.length 
                        : 0;
                    classAverages.push(avg);
                }
                
                // Display student stats
                document.getElementById('studentStats').innerHTML = `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">${student}</h5>
                            <p class="mb-1"><strong>Average:</strong> ${average.toFixed(1)}%</p>
                            <p class="mb-1"><strong>Best:</strong> ${processedData.assessments[bestIndex]} (${bestScore.toFixed(1)}%)</p>
                            <p class="mb-1"><strong>Needs Improvement:</strong> ${processedData.assessments[worstIndex]} (${worstScore.toFixed(1)}%)</p>
                            <p class="mb-1"><strong>Performance:</strong> 
                                ${average >= 80 ? '<span class="badge badge-success">High</span>' : 
                                  average >= 60 ? '<span class="badge badge-info">Medium</span>' : 
                                  '<span class="badge badge-warning">Low</span>'}
                            </p>
                        </div>
                    </div>
                `;
                
                // Create student detail chart
                const ctx = document.getElementById('studentDetailChart').getContext('2d');
                
                // Destroy existing chart if it exists
                if (window.studentDetailChart && typeof window.studentDetailChart.destroy === 'function') {
                    window.studentDetailChart.destroy();
                }
                
                // Create chart
                window.studentDetailChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: processedData.assessments,
                        datasets: [
                            {
                                label: student,
                                data: scores,
                                backgroundColor: 'rgba(67, 97, 238, 0.2)',
                                borderColor: 'rgba(67, 97, 238, 1)',
                                borderWidth: 3,
                                tension: 0.1,
                                fill: false
                            },
                            {
                                label: 'Class Average',
                                data: classAverages,
                                backgroundColor: 'rgba(76, 201, 240, 0.2)',
                                borderColor: 'rgba(76, 201, 240, 1)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                tension: 0.1,
                                fill: false
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${student}'s Performance Compared to Class Average`
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Score (%)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Assessments'
                                }
                            }
                        }
                    }
                });
            }
            
            // Print dashboard functionality
            document.getElementById('printDashboardBtn').addEventListener('click', function() {
                window.print();
            });
            
            // Save dashboard functionality (basic implementation)
            document.getElementById('saveDashboardBtn').addEventListener('click', function() {
                alert('This feature would save the current state of the dashboard for later use.');
            });
            
            // Export as PDF (placeholder)
            document.getElementById('exportPDF').addEventListener('click', function() {
                alert('This feature would export the dashboard as a PDF document.');
            });
            
            // Export as CSV
            document.getElementById('exportCSV').addEventListener('click', function() {
                // Create CSV content
                let csvContent = 'Student';
                processedData.assessments.forEach(assessment => {
                    csvContent += `,${assessment}`;
                });
                csvContent += ',Average\n';
                
                processedData.students.forEach((student, i) => {
                    csvContent += student;
                    const scores = processedData.normalizedScores[i];
                    
                    scores.forEach(score => {
                        csvContent += `,${score !== null ? score.toFixed(1) : ''}`;
                    });
                    
                    // Add average
                    const validScores = scores.filter(score => score !== null);
                    const average = validScores.length > 0 
                        ? validScores.reduce((sum, score) => sum + score, 0) / validScores.length 
                        : 0;
                    csvContent += `,${average.toFixed(1)}\n`;
                });
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'dashboard_data.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        };
    </script>
</body>
</html>